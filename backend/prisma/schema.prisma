generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  jobs      Job[]
  reports   Report[]
  lots      Lot[]
  
  @@map("users")
}

// ============================================
// Job Processing
// ============================================

model Job {
  id           String    @id @default(uuid())
  userId       String
  s3Key        String    // S3 location of uploaded CAS file
  fileName     String
  fileSize     Int?
  status       JobStatus @default(PENDING)
  errorMessage String?   @db.Text
  
  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  completedAt  DateTime?
  
  // Processing metadata
  processedBy  String?   // Worker ID that processed this job
  retryCount   Int       @default(0)
  
  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  report       Report?
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("jobs")
}

enum JobStatus {
  PENDING      // Job created, waiting for processing
  PROCESSING   // Worker is processing the job
  COMPLETED    // Job completed successfully
  FAILED       // Job failed with error
}

// ============================================
// Financial Data - User Portfolio Lots
// ============================================

model Lot {
  id              String   @id @default(uuid())
  userId          String
  jobId           String
  
  // Fund Information
  fundName        String
  folioNumber     String?
  isin            String?  // International Securities Identification Number
  
  // Transaction Details
  transactionDate DateTime
  transactionType String   // BUY, SELL, DIVIDEND_REINVEST, etc.
  units           Float
  nav             Float    // Net Asset Value at transaction time
  amount          Float    // Total transaction amount
  
  // Tax tracking
  isLongTerm      Boolean  @default(false) // > 1 year holding
  acquisitionCost Float?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([jobId])
  @@index([fundName])
  @@index([transactionDate])
  @@map("user_lots")
}

// ============================================
// NAV (Net Asset Value) Historical Data
// ============================================

model NavHistory {
  id        String   @id @default(uuid())
  fundName  String
  isin      String?
  date      DateTime
  nav       Float
  
  // Additional metrics
  dayChange Float?   // Daily change percentage
  
  createdAt DateTime @default(now())
  
  @@unique([fundName, date])
  @@index([fundName])
  @@index([date])
  @@index([isin])
  @@map("nav_history")
}

// ============================================
// Analysis Reports
// ============================================

model Report {
  id        String   @id @default(uuid())
  jobId     String   @unique
  userId    String
  
  // Report data stored as JSON
  reportData Json     // Complete report with all calculations
  
  // Quick access fields (denormalized for performance)
  powerScoreSummary   Json?    // Summary of Power Scores per fund
  totalInvestment     Float?   // Total current investment value
  projectedReturns    Float?   // Projected annual returns
  switchingCost       Float?   // Total cost to switch funds
  netBenefit          Float?   // Net annual benefit
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@map("reports")
}

// ============================================
// System Configuration (Optional)
// ============================================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("system_config")
}

// ============================================
// Benchmark Data (for Power Score calculation)
// ============================================

model Benchmark {
  id         String   @id @default(uuid())
  name       String   @unique  // e.g., "NIFTY_50", "SENSEX"
  date       DateTime
  value      Float
  
  createdAt  DateTime @default(now())
  
  @@unique([name, date])
  @@index([name])
  @@index([date])
  @@map("benchmarks")
}
